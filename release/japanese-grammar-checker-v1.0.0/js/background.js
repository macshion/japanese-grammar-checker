let i=!1;function s(){if(i){console.log("Extension already initialized, skipping initialization");return}console.log("Initializing Japanese Grammar Checker extension"),chrome.sidePanel.setPanelBehavior({openPanelOnActionClick:!0},()=>{console.log("Panel behavior set successfully")}),chrome.contextMenus.removeAll(()=>{console.log("Removed all existing context menu items"),chrome.contextMenus.create({id:"checkJapaneseGrammar",title:"日本語文法をチェック",contexts:["selection"]},()=>{chrome.runtime.lastError?console.error("Error creating context menu:",chrome.runtime.lastError):(console.log("Context menu created successfully"),i=!0)})})}s();chrome.runtime.onInstalled.addListener(e=>{console.log("Extension installed or updated:",e.reason),s()});chrome.runtime.onStartup.addListener(()=>{console.log("Browser started, initializing extension"),s()});function c(e){return new Promise(t=>{chrome.tabs.sendMessage(e,{action:"ping"},n=>{chrome.runtime.lastError||!n?chrome.scripting.executeScript({target:{tabId:e},files:["js/content.js"]}).then(()=>{setTimeout(t,100)}).catch(r=>{console.error("Failed to inject content script:",r),t()}):t()})})}function o(e=5){let t=0;function n(){if(t>=e){console.log("Max attempts reached for checking sidebar");return}t++,console.log(`Checking if sidebar has received text (attempt ${t})`),chrome.runtime.sendMessage({action:"checkForSelectedText"},r=>{chrome.runtime.lastError||!r||!r.success?(console.log("Sidebar not ready yet, will retry in 500ms"),setTimeout(n,500)):console.log("Sidebar has successfully received the message")})}setTimeout(n,300)}chrome.contextMenus.onClicked.addListener(async(e,t)=>{if(e.menuItemId==="checkJapaneseGrammar"&&e.selectionText){if(!/[\u3000-\u303f\u3040-\u309f\u30a0-\u30ff\uff00-\uff9f\u4e00-\u9faf\u3400-\u4dbf]/.test(e.selectionText)){chrome.notifications.create({type:"basic",iconUrl:"icon.svg",title:"日本語文法チェッカー",message:"選択されたテキストに日本語が含まれていません。",priority:2});return}chrome.storage.local.set({selectedText:e.selectionText},()=>{try{chrome.sidePanel.open({windowId:t.windowId},()=>{console.log("Side panel opened successfully"),c(t.id).then(()=>{try{chrome.tabs.sendMessage(t.id,{action:"updateSelectedText",text:e.selectionText},r=>{chrome.runtime.lastError&&(console.error("Error sending message to tab:",chrome.runtime.lastError),o())})}catch(r){console.error("Error sending message to tab:",r),o()}})})}catch(r){console.error("Error opening side panel:",r),o()}})}});chrome.runtime.onMessage.addListener((e,t,n)=>(e.action==="updateSidebarText"?(chrome.storage.local.set({selectedText:e.text}),n({success:!0})):e.action==="ping"&&n({pong:!0}),!0));
