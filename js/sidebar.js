import{A as I,U as p,S as u,a as L,b as N}from"./config.js";function b(){if(document.querySelector(".api-key-prompt")){const s=document.getElementById("apiKeyInput");if(s){s.focus();return}}const c=document.querySelector(".container"),y=document.createElement("div");y.className="api-key-prompt",y.innerHTML=`
        <h3>API„Ç≠„Éº„ÅÆË®≠ÂÆö</h3>
        <p>OpenAI API„Ç≠„Éº„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºö</p>
        <input type="password" id="apiKeyInput" placeholder="sk-..." />
        <button id="saveApiKey">‰øùÂ≠ò</button>
    `,c.prepend(y),document.getElementById("saveApiKey").addEventListener("click",()=>{const s=document.getElementById("apiKeyInput").value.trim();s&&chrome.storage.local.set({[I.STORAGE_KEYS.API_KEY]:s},()=>{y.remove()})})}async function C(){const c=document.getElementById(UI_ELEMENTS.HISTORY_LIST);document.getElementById(UI_ELEMENTS.HISTORY_CONTAINER);try{chrome.storage.local.get([STORAGE_CONFIG.KEYS.HISTORY],y=>{const s=y[STORAGE_CONFIG.KEYS.HISTORY]||[];if(s.length===0){c.innerHTML=`<li class="text-gray-500">${UI_MESSAGES.HISTORY_EMPTY}</li>`;return}c.innerHTML=s.map((l,m)=>`
                <li class="history-item border-b border-gray-200 p-4 hover:bg-gray-50 ${m===0?"selected":""}" data-index="${m}">
                    <div class="flex justify-between items-start">
                        <div class="text-sm text-gray-600">${new Date(l.timestamp).toLocaleString("ja-JP")}</div>
                        <div class="history-actions">
                            <button class="history-copy-btn icon-button" title="‰øÆÊ≠£Êñá„Çí„Ç≥„Éî„Éº">üìã</button>
                            <button class="history-view-original-btn icon-button" title="ÂéüÊñá„ÇíË°®Á§∫">üìÑ</button>
                            ${l.explanation?'<button class="history-view-explanation-btn icon-button" title="Ë™¨Êòé„ÇíË°®Á§∫">‚ÑπÔ∏è</button>':""}
                            ${l.fullResponse?'<button class="history-view-full-btn icon-button" title="ÂÆåÂÖ®„Å™ÂøúÁ≠î„ÇíË°®Á§∫">üëÅÔ∏è</button>':""}
                            <button class="history-delete-btn icon-button" title="ÂâäÈô§">üóëÔ∏è</button>
                        </div>
                    </div>
                    <div class="mt-2 text-gray-600 corrected-text">${l.correctedText}</div>
                </li>
            `).join(""),c.querySelectorAll(".history-item").forEach(l=>{const m=parseInt(l.getAttribute("data-index"));l.addEventListener("click",i=>{i.target.closest(".history-actions")||(c.querySelectorAll(".history-item").forEach(e=>{e.classList.remove("selected")}),l.classList.add("selected"),document.getElementById(UI_ELEMENTS.INPUT_TEXT).value=s[m].originalText,document.getElementById(UI_ELEMENTS.RESULT).textContent=s[m].correctedText,document.getElementById(UI_ELEMENTS.RESULT_CONTAINER).classList.remove("hidden"))}),l.querySelector(".history-copy-btn").addEventListener("click",i=>{i.stopPropagation(),navigator.clipboard.writeText(s[m].correctedText);const e=i.target,n=e.textContent;e.textContent="‚úì",setTimeout(()=>{e.textContent=n},1e3)});const _=l.querySelector(".history-view-original-btn");_&&_.addEventListener("click",i=>{i.stopPropagation();const e=document.createElement("div");e.className="modal-overlay";const n=document.createElement("div");n.className="modal-content";const t=document.createElement("div");t.className="modal-header";const d=document.createElement("h3");d.textContent=UI_MESSAGES.ORIGINAL_TEXT_TITLE;const a=document.createElement("button");a.className="modal-close-btn",a.textContent="‚úï",a.addEventListener("click",()=>{document.body.removeChild(e)}),t.appendChild(d),t.appendChild(a);const r=document.createElement("div");r.className="modal-body";const o=document.createElement("pre");o.className="original-text-modal",o.textContent=s[m].originalText,r.appendChild(o),n.appendChild(t),n.appendChild(r),e.appendChild(n),document.body.appendChild(e),e.addEventListener("click",E=>{E.target===e&&document.body.removeChild(e)})});const g=l.querySelector(".history-view-explanation-btn");g&&g.addEventListener("click",i=>{i.stopPropagation();const e=document.createElement("div");e.className="modal-overlay";const n=document.createElement("div");n.className="modal-content";const t=document.createElement("div");t.className="modal-header";const d=document.createElement("h3");d.textContent=UI_MESSAGES.EXPLANATION_TITLE;const a=document.createElement("button");a.className="modal-close-btn",a.textContent="‚úï",a.addEventListener("click",()=>{document.body.removeChild(e)}),t.appendChild(d),t.appendChild(a);const r=document.createElement("div");r.className="modal-body";const o=document.createElement("pre");o.className="explanation-text-modal",o.textContent=s[m].explanation,r.appendChild(o),n.appendChild(t),n.appendChild(r),e.appendChild(n),document.body.appendChild(e),e.addEventListener("click",E=>{E.target===e&&document.body.removeChild(e)})});const v=l.querySelector(".history-view-full-btn");v&&v.addEventListener("click",i=>{i.stopPropagation();const e=document.createElement("div");e.className="modal-overlay";const n=document.createElement("div");n.className="modal-content";const t=document.createElement("div");t.className="modal-header";const d=document.createElement("h3");d.textContent=UI_MESSAGES.FULL_RESPONSE_TITLE;const a=document.createElement("button");a.className="modal-close-btn",a.textContent="‚úï",a.addEventListener("click",()=>{document.body.removeChild(e)}),t.appendChild(d),t.appendChild(a);const r=document.createElement("div");r.className="modal-body";const o=document.createElement("pre");o.className="full-response-text",o.textContent=s[m].fullResponse,r.appendChild(o),n.appendChild(t),n.appendChild(r),e.appendChild(n),document.body.appendChild(e),e.addEventListener("click",E=>{E.target===e&&document.body.removeChild(e)})}),l.querySelector(".history-delete-btn").addEventListener("click",i=>{if(i.stopPropagation(),confirm("„Åì„ÅÆÂ±•Ê≠¥„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü")){const e=[...s];e.splice(m,1),chrome.storage.local.set({[STORAGE_CONFIG.KEYS.HISTORY]:e},()=>{C()})}})})})}catch(y){console.error("Failed to load history:",y),c.innerHTML=`<li class="text-red-500">${UI_MESSAGES.ERROR_PREFIX}${y.message}</li>`}}document.addEventListener("DOMContentLoaded",()=>{chrome.storage.local.get([I.STORAGE_KEYS.API_KEY],c=>{c[I.STORAGE_KEYS.API_KEY]||b()}),chrome.storage.local.get(["selectedText"],c=>{c.selectedText&&(document.getElementById(p.INPUT_TEXT).value=c.selectedText,chrome.storage.local.remove(["selectedText"]))}),C()});document.addEventListener("DOMContentLoaded",()=>{const c=document.getElementById(p.INPUT_TEXT),y=document.getElementById(p.CHECK_BUTTON),s=document.getElementById(p.CLEAR_BUTTON),l=document.getElementById(p.LOADING_SPINNER),m=document.getElementById(p.RESULT_CONTAINER),_=document.getElementById(p.RESULT),g=document.getElementById(p.COPY_BUTTON),v=document.getElementById(p.CLEAR_HISTORY_BUTTON),i=document.getElementById(p.EXPORT_HISTORY_BUTTON),e=document.getElementById(p.IMPORT_HISTORY_BUTTON),n=document.getElementById(p.IMPORT_HISTORY_FILE);e==null||e.addEventListener("click",()=>{n.click()}),n==null||n.addEventListener("change",t=>{const d=t.target.files[0];if(!d)return;const a=new FileReader;a.onload=r=>{try{const o=JSON.parse(r.target.result);if(!o.history||!Array.isArray(o.history))throw new Error("ÁÑ°Âäπ„Å™„Éï„Ç°„Ç§„É´ÂΩ¢Âºè„Åß„Åô„ÄÇ");confirm(`${o.history.length}‰ª∂„ÅÆÂ±•Ê≠¥„Çí„Ç§„É≥„Éù„Éº„Éà„Åó„Åæ„Åô„ÅãÔºüÊó¢Â≠ò„ÅÆÂ±•Ê≠¥„Å®Áµ±Âêà„Åï„Çå„Åæ„Åô„ÄÇ`)&&chrome.storage.local.get([u.KEYS.HISTORY],E=>{let h=E[u.KEYS.HISTORY]||[];const R=[...o.history,...h],S=[],O=new Set;for(const T of R)O.has(T.timestamp)||(O.add(T.timestamp),S.push(T));S.sort((T,x)=>new Date(x.timestamp)-new Date(T.timestamp)),S.length>u.MAX_HISTORY_ITEMS&&(S.length=u.MAX_HISTORY_ITEMS),chrome.storage.local.set({[u.KEYS.HISTORY]:S},()=>{C(),alert(`${o.history.length}‰ª∂„ÅÆÂ±•Ê≠¥„Çí„Ç§„É≥„Éù„Éº„Éà„Åó„Åæ„Åó„Åü„ÄÇ`)})})}catch(o){console.error("Failed to import history:",o),alert(`„Ç§„É≥„Éù„Éº„Éà‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: ${o.message}`)}n.value=""},a.readAsText(d)}),i==null||i.addEventListener("click",()=>{try{chrome.storage.local.get([u.KEYS.HISTORY],t=>{const d=t[u.KEYS.HISTORY]||[];if(d.length===0){alert("„Ç®„ÇØ„Çπ„Éù„Éº„Éà„Åô„ÇãÂ±•Ê≠¥„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ");return}const a={exportDate:new Date().toISOString(),history:d},r=JSON.stringify(a,null,2),o=new Blob([r],{type:"application/json"}),E=URL.createObjectURL(o),h=document.createElement("a");h.href=E,h.download=`japanese-grammar-history-${new Date().toISOString().slice(0,10)}.json`,document.body.appendChild(h),h.click(),document.body.removeChild(h),URL.revokeObjectURL(E)})}catch(t){console.error("Failed to export history:",t),alert(`„Ç®„ÇØ„Çπ„Éù„Éº„Éà‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: ${t.message}`)}}),v==null||v.addEventListener("click",()=>{if(confirm("„Åô„Åπ„Å¶„ÅÆÂ±•Ê≠¥„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü"))try{chrome.storage.local.remove([u.KEYS.HISTORY],()=>{C(),alert(L.HISTORY_CLEARED)})}catch(t){console.error("Failed to clear history:",t),alert(`${L.ERROR_PREFIX}${t.message}`)}}),s.addEventListener("click",()=>{c.value="",m.classList.add("hidden"),c.focus()}),c.addEventListener("input",()=>{s.style.display=c.value.length>0?"flex":"none"}),s.style.display="none",g.addEventListener("click",async()=>{try{await navigator.clipboard.writeText(_.textContent),g.classList.add("copied"),setTimeout(()=>{g.classList.remove("copied")},2e3)}catch(t){console.error("Failed to copy text:",t)}}),y.addEventListener("click",async()=>{if(!c.value.trim()){alert(L.EMPTY_INPUT);return}chrome.storage.local.get([I.STORAGE_KEYS.API_KEY],async t=>{const d=t[I.STORAGE_KEYS.API_KEY];if(!d){alert(L.API_KEY_MISSING),b();return}l.classList.remove("hidden"),m.classList.add("hidden"),t.textContent="";try{const r=await(await fetch(I.API_ENDPOINT,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${d}`},body:JSON.stringify({...I.MODEL_CONFIG,messages:[{role:"system",content:N.GRAMMAR_CHECK},{role:"user",content:c.value}]})})).json();if(r.error)throw new Error(r.error.message);const o=r.choices[0].message.content;let E=o;const h=o.match(/```‰øÆÊ≠£\n([\s\S]*?)\n```/);h&&h[1]&&(E=h[1].trim());const R=o.match(/```Ë™¨Êòé\n([\s\S]*?)\n```/),S=R&&R[1]?R[1].trim():"";t.textContent=E,m.classList.remove("hidden");try{chrome.storage.local.get([u.KEYS.HISTORY],O=>{const T=O[u.KEYS.HISTORY]||[];T.unshift({timestamp:new Date().toISOString(),originalText:c.value,correctedText:E,fullResponse:o,explanation:S}),T.length>u.MAX_HISTORY_ITEMS&&(T.length=u.MAX_HISTORY_ITEMS),chrome.storage.local.set({[u.KEYS.HISTORY]:T},()=>{C(),setTimeout(()=>{const x=document.querySelector(".history-item");x&&(x.classList.add("selected"),document.getElementById(p.RESULT).textContent=T[0].correctedText,document.getElementById(p.RESULT_CONTAINER).classList.remove("hidden"))},100)})})}catch(O){console.error("Failed to save to history:",O)}}catch(a){t.textContent=`${L.ERROR_PREFIX}${a.message}`,m.classList.remove("hidden")}finally{l.classList.add("hidden")}})})});
